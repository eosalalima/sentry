@page "/"
@inject IOptionsSnapshot<GsmSettings> SettingsSnapshot
@inject SettingsService SettingsService
@inject GsmService GsmService
@inject ToastService ToastService

<div class="content-grid">
    <section class="card">
        <h2>Send SMS</h2>
        <p>Send a text message using the configured GSM device.</p>

        <div class="button-row align-right">
            <button class="btn" type="button" @onclick="OpenConfig">Config</button>
        </div>

        <EditForm Model="@SmsMessage" OnValidSubmit="SendSms" FormName="sms-message">
            <AntiforgeryToken />
            <DataAnnotationsValidator />
            <ValidationSummary />

            <label>
                Mobile Number
                <InputText class="input" @bind-Value="SmsMessage.MobileNumber" placeholder="+15551234567" />
            </label>

            <label>
                Text Message
                <InputTextArea class="input textarea" @bind-Value="SmsMessage.TextMessage" rows="5" />
            </label>

            <div class="button-row">
                <button class="btn primary" type="submit">Send Message</button>
            </div>
        </EditForm>
    </section>
</div>

@if (IsConfigOpen)
{
    <div class="modal-backdrop" @onclick="CloseConfig">
        <section class="modal-card" @onclick:stopPropagation="true">
            <div class="modal-header">
                <div>
                    <h2>GSM Device Configuration</h2>
                    <p>Update the serial connection and verify the GSM device.</p>
                </div>
                <button class="btn ghost" type="button" @onclick="CloseConfig">Close</button>
            </div>

            <EditForm Model="@SettingsModel" OnValidSubmit="SaveSettings" FormName="gsm-settings">
                <AntiforgeryToken />
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-grid">
                    <label>
                        Serial Port
                        <InputText class="input" @bind-Value="SettingsModel.SerialPort" placeholder="COM3" />
                    </label>

                    <label>
                        Baud Rate
                        <InputNumber class="input" @bind-Value="SettingsModel.BaudRate" />
                    </label>

                    <label>
                        Data Bits
                        <InputNumber class="input" @bind-Value="SettingsModel.DataBits" />
                    </label>

                    <label>
                        Parity
                        <InputSelect class="input" @bind-Value="SettingsModel.Parity">
                            @foreach (var value in Enum.GetValues<Parity>())
                            {
                                <option value="@value">@value</option>
                            }
                        </InputSelect>
                    </label>

                    <label>
                        Stop Bits
                        <InputSelect class="input" @bind-Value="SettingsModel.StopBits">
                            @foreach (var value in Enum.GetValues<StopBits>())
                            {
                                <option value="@value">@value</option>
                            }
                        </InputSelect>
                    </label>

                    <label>
                        Handshake
                        <InputSelect class="input" @bind-Value="SettingsModel.Handshake">
                            @foreach (var value in Enum.GetValues<Handshake>())
                            {
                                <option value="@value">@value</option>
                            }
                        </InputSelect>
                    </label>

                    <label>
                        Read Timeout (ms)
                        <InputNumber class="input" @bind-Value="SettingsModel.ReadTimeout" />
                    </label>

                    <label>
                        Write Timeout (ms)
                        <InputNumber class="input" @bind-Value="SettingsModel.WriteTimeout" />
                    </label>

                    <label>
                        New Line Sequence
                        <InputText class="input" @bind-Value="SettingsModel.NewLine" />
                    </label>
                </div>

                <div class="button-row">
                    <button class="btn primary" type="submit">Save Settings</button>
                    <button class="btn" type="button" @onclick="DetectDevice">Detect Device</button>
                </div>
            </EditForm>

            <div class="divider"></div>

            <div class="modal-section">
                <h3>Send Test SMS</h3>
                <p>Verify the GSM device by sending a quick test message.</p>

                <EditForm Model="@TestSmsMessage" OnValidSubmit="SendTestSms" FormName="sms-test">
                    <AntiforgeryToken />
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <label>
                        Mobile Number
                        <InputText class="input" @bind-Value="TestSmsMessage.MobileNumber" placeholder="+15551234567" />
                    </label>

                    <label>
                        Test Message
                        <InputTextArea class="input textarea" @bind-Value="TestSmsMessage.TextMessage" rows="4" />
                    </label>

                    <div class="button-row">
                        <button class="btn primary" type="submit">Send Test SMS</button>
                    </div>
                </EditForm>
            </div>
        </section>
    </div>
}

@code {
    [SupplyParameterFromForm]
    private GsmSettings SettingsModel { get; set; } = new();

    [SupplyParameterFromForm]
    private SmsMessage SmsMessage { get; set; } = new();

    [SupplyParameterFromForm]
    private SmsMessage TestSmsMessage { get; set; } = new()
    {
        TextMessage = "SentrySMS test message."
    };

    private bool IsConfigOpen { get; set; }

    protected override void OnInitialized()
    {
        if (string.IsNullOrWhiteSpace(SettingsModel.SerialPort))
        {
            SettingsModel = new GsmSettings
            {
                SerialPort = SettingsSnapshot.Value.SerialPort,
                BaudRate = SettingsSnapshot.Value.BaudRate,
                DataBits = SettingsSnapshot.Value.DataBits,
                Parity = SettingsSnapshot.Value.Parity,
                StopBits = SettingsSnapshot.Value.StopBits,
                Handshake = SettingsSnapshot.Value.Handshake,
                ReadTimeout = SettingsSnapshot.Value.ReadTimeout,
                WriteTimeout = SettingsSnapshot.Value.WriteTimeout,
                NewLine = SettingsSnapshot.Value.NewLine
            };
        }
    }

    private void OpenConfig()
    {
        IsConfigOpen = true;
    }

    private void CloseConfig()
    {
        IsConfigOpen = false;
    }

    private async Task SaveSettings()
    {
        await SettingsService.SaveGsmSettingsAsync(SettingsModel);
        ToastService.ShowToast("Settings saved", "GSM configuration updated in appsettings.json.", ToastLevel.Success);
    }

    private async Task DetectDevice()
    {
        var result = await GsmService.DetectDeviceAsync(SettingsModel);
        if (result.Success)
        {
            ToastService.ShowToast("Device detected", $"AT response: {result.Response}", ToastLevel.Success);
        }
        else
        {
            ToastService.ShowToast("Device not detected", result.Response, ToastLevel.Warning);
        }
    }

    private async Task SendSms()
    {
        var result = await GsmService.SendSmsAsync(SmsMessage);
        if (result.Success)
        {
            ToastService.ShowToast("Message sent", "SMS successfully delivered to the GSM module.", ToastLevel.Success);
        }
        else
        {
            ToastService.ShowToast("Message failed", result.Response, ToastLevel.Error);
        }
    }

    private async Task SendTestSms()
    {
        var result = await GsmService.SendSmsAsync(TestSmsMessage);
        if (result.Success)
        {
            ToastService.ShowToast("Test message sent", "Test SMS successfully delivered to the GSM module.", ToastLevel.Success);
        }
        else
        {
            ToastService.ShowToast("Test message failed", result.Response, ToastLevel.Error);
        }
    }
}
