@page "/personnel"
@using Microsoft.Data.SqlClient
@using Microsoft.EntityFrameworkCore
@using SentryGate.Data
@inject IDbContextFactory<StaffDbContext> StaffDbFactory

<h1>Personnel</h1>

@if (!string.IsNullOrWhiteSpace(_statusMessage))
{
    <div class="alert alert-success">@_statusMessage</div>
}
@if (!string.IsNullOrWhiteSpace(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <button class="btn btn-primary" type="button" @onclick="OpenAddDialog">Add</button>
    </div>
    <div class="text-muted">
        @if (_totalCount > 0)
        {
            <span>Showing @((_currentPage - 1) * _pageSize + 1)-@Math.Min(_currentPage * _pageSize, _totalCount) of @_totalCount</span>
        }
    </div>
</div>

@if (_isLoading)
{
    <p>Loading personnel...</p>
}
else if (_personnel.Count == 0)
{
    <p>No personnel records found.</p>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-sm align-middle">
            <thead>
                <tr>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Middle Initial</th>
                    <th>Designation</th>
                    <th>Birth Date</th>
                    <th>Field06</th>
                    <th>Field07</th>
                    <th>Field08</th>
                    <th>Field09</th>
                    <th>Field10</th>
                    <th>Field11</th>
                    <th>Field12</th>
                    <th>Mobile Number</th>
                    <th>Field14</th>
                    <th>Access Number</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var person in _personnel)
                {
                    <tr>
                        <td>@person.Field01</td>
                        <td>@person.Field02</td>
                        <td>@person.Field03</td>
                        <td>@person.Field04</td>
                        <td>@FormatDate(person.Field05)</td>
                        <td>@person.Field06</td>
                        <td>@person.Field07</td>
                        <td>@person.Field08</td>
                        <td>@person.Field09</td>
                        <td>@person.Field10</td>
                        <td>@person.Field11</td>
                        <td>@person.Field12</td>
                        <td>@person.Field13</td>
                        <td>@person.Field14</td>
                        <td>@person.Field15</td>
                        <td>@person.Field16</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-secondary me-2" type="button" @onclick="() => OpenEditDialog(person)">Edit</button>
                            <button class="btn btn-sm btn-outline-danger" type="button" @onclick="() => DeletePersonnelAsync(person)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<nav aria-label="Personnel pagination" class="mt-3">
    <ul class="pagination">
        <li class="page-item @(HasPreviousPage ? string.Empty : "disabled")">
            <button class="page-link" type="button" @onclick="PreviousPageAsync">Previous</button>
        </li>
        <li class="page-item disabled">
            <span class="page-link">Page @_currentPage of @TotalPages</span>
        </li>
        <li class="page-item @(HasNextPage ? string.Empty : "disabled")">
            <button class="page-link" type="button" @onclick="NextPageAsync">Next</button>
        </li>
    </ul>
</nav>

@if (_showDialog)
{
    <dialog open class="p-4">
        <h2 class="h4 mb-3">@(_isNewRecord ? "Add Personnel" : "Edit Personnel")</h2>
        <EditForm Model="_editModel" OnValidSubmit="SavePersonnelAsync">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Last Name</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field01" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">First Name</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field02" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Middle Initial</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field03" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Designation</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field04" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Birth Date</label>
                    <InputDate class="form-control" @bind-Value="_editModel.Field05" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field06</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field06" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field07</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field07" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field08</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field08" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field09</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field09" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field10</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field10" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field11</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field11" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field12</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field12" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Mobile Number</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field13" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Field14</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field14" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Access Number</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field15" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <InputText class="form-control" @bind-Value="_editModel.Field16" />
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-end gap-2">
                <button class="btn btn-secondary" type="button" @onclick="CloseDialog">Cancel</button>
                <button class="btn btn-primary" type="submit" disabled="@_isSaving">Save</button>
            </div>
        </EditForm>
    </dialog>
}

@code {
    private const int DefaultPageSize = 10;
    private readonly List<PersonnelRecord> _personnel = new();
    private bool _isLoading = true;
    private bool _isSaving;
    private string? _statusMessage;
    private string? _errorMessage;
    private int _currentPage = 1;
    private int _pageSize = DefaultPageSize;
    private int _totalCount;
    private bool _showDialog;
    private bool _isNewRecord = true;
    private string? _editingOriginalAccessNumber;
    private PersonnelRecord _editModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadPersonnelAsync();
    }

    private int TotalPages => _totalCount == 0 ? 1 : (int)Math.Ceiling(_totalCount / (double)_pageSize);
    private bool HasPreviousPage => _currentPage > 1;
    private bool HasNextPage => _currentPage < TotalPages;

    private async Task LoadPersonnelAsync()
    {
        _isLoading = true;
        _errorMessage = null;
        _statusMessage = null;

        try
        {
            await using var db = await StaffDbFactory.CreateDbContextAsync();
            _totalCount = await db.Database.SqlQueryRaw<int>("SELECT COUNT(*) AS [Value] FROM [dbo].[MyDataTable]")
                .SingleAsync();

            _currentPage = Math.Min(_currentPage, TotalPages);
            var offset = (_currentPage - 1) * _pageSize;

            _personnel.Clear();
            var results = await db.Database.SqlQueryRaw<PersonnelRecord>(@"
SELECT Field01, Field02, Field03, Field04, TRY_CONVERT(datetime, Field05) AS Field05, Field06, Field07, Field08,
       Field09, Field10, Field11, Field12, Field13, Field14, Field15, Field16
FROM [dbo].[MyDataTable]
ORDER BY Field02, Field03, Field01
OFFSET @offset ROWS FETCH NEXT @pageSize ROWS ONLY;",
                    new SqlParameter("@offset", offset),
                    new SqlParameter("@pageSize", _pageSize))
                .ToListAsync();

            _personnel.AddRange(results);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to load personnel: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OpenAddDialog()
    {
        _isNewRecord = true;
        _editingOriginalAccessNumber = null;
        _editModel = new PersonnelRecord();
        _showDialog = true;
    }

    private void OpenEditDialog(PersonnelRecord record)
    {
        _isNewRecord = false;
        _editingOriginalAccessNumber = record.Field15;
        _editModel = record.Clone();
        _showDialog = true;
    }

    private void CloseDialog()
    {
        _showDialog = false;
    }

    private async Task SavePersonnelAsync()
    {
        if (_isSaving)
        {
            return;
        }

        _isSaving = true;
        _errorMessage = null;
        _statusMessage = null;

        try
        {
            await using var db = await StaffDbFactory.CreateDbContextAsync();

            if (_isNewRecord)
            {
                await db.Database.ExecuteSqlInterpolatedAsync($@"
INSERT INTO [dbo].[MyDataTable]
(Field01, Field02, Field03, Field04, Field05, Field06, Field07, Field08,
 Field09, Field10, Field11, Field12, Field13, Field14, Field15, Field16)
VALUES
({_editModel.Field01}, {_editModel.Field02}, {_editModel.Field03}, {_editModel.Field04},
 {_editModel.Field05}, {_editModel.Field06}, {_editModel.Field07}, {_editModel.Field08},
 {_editModel.Field09}, {_editModel.Field10}, {_editModel.Field11}, {_editModel.Field12},
 {_editModel.Field13}, {_editModel.Field14}, {_editModel.Field15}, {_editModel.Field16});");
                _statusMessage = "Personnel record added.";
            }
            else
            {
                if (string.IsNullOrWhiteSpace(_editingOriginalAccessNumber))
                {
                    _errorMessage = "Unable to update the record because it does not have an access number.";
                    return;
                }

                await db.Database.ExecuteSqlInterpolatedAsync($@"
UPDATE [dbo].[MyDataTable]
SET Field01 = {_editModel.Field01},
    Field02 = {_editModel.Field02},
    Field03 = {_editModel.Field03},
    Field04 = {_editModel.Field04},
    Field05 = {_editModel.Field05},
    Field06 = {_editModel.Field06},
    Field07 = {_editModel.Field07},
    Field08 = {_editModel.Field08},
    Field09 = {_editModel.Field09},
    Field10 = {_editModel.Field10},
    Field11 = {_editModel.Field11},
    Field12 = {_editModel.Field12},
    Field13 = {_editModel.Field13},
    Field14 = {_editModel.Field14},
    Field15 = {_editModel.Field15},
    Field16 = {_editModel.Field16}
WHERE Field15 = {_editingOriginalAccessNumber};");
                _statusMessage = "Personnel record updated.";
            }

            _showDialog = false;
            await LoadPersonnelAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to save personnel: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DeletePersonnelAsync(PersonnelRecord record)
    {
        _errorMessage = null;
        _statusMessage = null;

        if (string.IsNullOrWhiteSpace(record.Field15))
        {
            _errorMessage = "Unable to delete the record because it does not have an access number.";
            return;
        }

        try
        {
            await using var db = await StaffDbFactory.CreateDbContextAsync();
            await db.Database.ExecuteSqlInterpolatedAsync($@"
DELETE FROM [dbo].[MyDataTable]
WHERE Field15 = {record.Field15};");

            _statusMessage = "Personnel record deleted.";
            await LoadPersonnelAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Unable to delete personnel: {ex.Message}";
        }
    }

    private async Task PreviousPageAsync()
    {
        if (!HasPreviousPage)
        {
            return;
        }

        _currentPage--;
        await LoadPersonnelAsync();
    }

    private async Task NextPageAsync()
    {
        if (!HasNextPage)
        {
            return;
        }

        _currentPage++;
        await LoadPersonnelAsync();
    }

    private static string FormatDate(DateTime? date)
    {
        return date.HasValue ? date.Value.ToString("yyyy-MM-dd") : string.Empty;
    }

    private sealed class PersonnelRecord
    {
        public string? Field01 { get; set; }
        public string? Field02 { get; set; }
        public string? Field03 { get; set; }
        public string? Field04 { get; set; }
        public DateTime? Field05 { get; set; }
        public string? Field06 { get; set; }
        public string? Field07 { get; set; }
        public string? Field08 { get; set; }
        public string? Field09 { get; set; }
        public string? Field10 { get; set; }
        public string? Field11 { get; set; }
        public string? Field12 { get; set; }
        public string? Field13 { get; set; }
        public string? Field14 { get; set; }
        public string? Field15 { get; set; }
        public string? Field16 { get; set; }

        public PersonnelRecord Clone()
        {
            return new PersonnelRecord
            {
                Field01 = Field01,
                Field02 = Field02,
                Field03 = Field03,
                Field04 = Field04,
                Field05 = Field05,
                Field06 = Field06,
                Field07 = Field07,
                Field08 = Field08,
                Field09 = Field09,
                Field10 = Field10,
                Field11 = Field11,
                Field12 = Field12,
                Field13 = Field13,
                Field14 = Field14,
                Field15 = Field15,
                Field16 = Field16
            };
        }
    }
}
