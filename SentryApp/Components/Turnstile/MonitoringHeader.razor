@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Configuration
@using Microsoft.AspNetCore.Hosting
@using System.Text.Json
@using System.Text.Json.Nodes
@using SentryApp.Data
@using SentryApp.Data.Query
@using SentryApp.Services
@implements IDisposable

<div class="mon-header">
    <div class="mon-brand">
        <img class="mon-logo" src="/img/logo.png" alt="Logo" />
        <div>
            <div class="mon-title">@MonitoringTitle</div>
            <div class="mon-subtitle"><strong>DR. GLORIA D. LACSON FOUNDATION COLLEGES</strong></div>
        </div>
    </div>

    <div>
        <button class="@LiveButtonClass" type="button">@LiveButtonLabel</button>
        <button class="btn btn-link" type="button" @onclick="TogglePollingServiceAsync"
            tooltip="Start/Stop Polling Service">
            @if (_isPollingActive)
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-stop-fill"
                    viewBox="0 0 16 16">
                    <path
                        d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5" />
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-play-fill"
                    viewBox="0 0 16 16">
                    <path
                        d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393" />
                </svg>
            }
        </button>
        <button class="btn btn-link" type="button" @onclick="OpenSettingsAsync">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-gear"
                viewBox="0 0 16 16">
                <path
                    d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0" />
                <path
                    d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z" />
            </svg>
        </button>
    </div>
</div>

@if (_showSettingsModal)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Monitoring Settings</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseSettings"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="connectionString">Database connection string</label>
                        <input class="form-control" id="connectionString" type="text" @bind="_connectionString"
                            placeholder="Server=...;Database=...;" disabled="@_isPollingActive" />
                    </div>

                    <div class="form-check form-switch mt-3 mb-3">
                        <input class="form-check-input" id="liveMode" type="checkbox" role="switch" @bind="_isLiveMode"
                            disabled="@_isPollingActive" />
                        <label class="form-check-label" for="liveMode">Live mode</label>
                        <div class="form-text">Toggle off to switch to demo mode.</div>
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="deviceSelect">Device to monitor</label>
                        <select class="form-select" id="deviceSelect" @bind="_selectedDeviceSerial"
                            disabled="@_isPollingActive">
                            @if (_devices.Count == 0)
                            {
                                <option disabled value="">No devices available</option>
                            }
                            else
                            {
                                <option value="@AllDevicesValue">All Devices</option>
                                @foreach (var device in _devices)
                                {
                                    <option value="@device.SerialNumber">@device.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="photosPath">Photos path</label>
                        <div class="input-group">
                            <input class="form-control" id="photosPath" type="text" @bind="_photosPath"
                                placeholder="C:\\Photos\\..." disabled="@_isPollingActive" />
                            <button class="btn btn-outline-secondary" type="button" @onclick="BrowsePhotosPathAsync"
                                disabled="@_isPollingActive">Browse</button>
                        </div>
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="pollInterval">Polling interval (ms)</label>
                        <input class="form-control" id="pollInterval" type="number" min="1" step="1"
                            @bind-value="_pollingIntervalMs" @bind-value:event="oninput" disabled="@_isPollingActive" />
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="highlightDuration">Highlight Display Duration (ms)</label>
                        <input class="form-control" id="highlightDuration" type="number" min="1" step="1"
                            @bind-value="_highlightDisplayDurationMs" @bind-value:event="oninput"
                            disabled="@_isPollingActive" />
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="lookbackSeconds">Lookback seconds on start</label>
                        <input class="form-control" id="lookbackSeconds" type="number" min="0" step="1"
                            @bind-value="_lookbackSecondsOnStart" @bind-value:event="oninput"
                            disabled="@_isPollingActive" />
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="maxRowsPerPoll">Max rows per poll</label>
                        <input class="form-control" id="maxRowsPerPoll" type="number" min="1" step="1"
                            @bind-value="_maxRowsPerPoll" @bind-value:event="oninput" disabled="@_isPollingActive" />
                    </div>
                </div>

                <div class="modal-footer">
                    @* <button class="btn @(_isPollingActive ? "btn-danger" : "btn-success") me-auto" type="button"
                        @onclick="TogglePollingServiceAsync">@(_isPollingActive ? "Stop Service" : "Run Service")</button> *@
                    <button class="btn btn-primary" type="button" @onclick="SaveSettingsAsync"
                        disabled="@_isPollingActive">Save</button>
                    <button class="btn btn-secondary" type="button" @onclick="CloseSettings">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" @onclick="CloseSettings"></div>
}

@code {
    [Inject]
    private IDbContextFactory<AccessControlDbContext> DbFactory { get; set; } = default!;

    [Inject]
    private IConfiguration Configuration { get; set; } = default!;

    [Inject]
    private IJSRuntime JsRuntime { get; set; } = default!;

    [Inject]
    private IWebHostEnvironment Environment { get; set; } = default!;

    [Inject]
    private TurnstilePollingController PollingController { get; set; } = default!;

    private const string AllDevicesValue = "1";
    private const string SelectedDeviceStorageKey = "SelectedDeviceSerial";

    private bool _showSettingsModal;
    private string _connectionString = string.Empty;
    private bool _isLiveMode = true;
    private string _selectedDeviceSerial = string.Empty;
    private string _photosPath = string.Empty;
    private int _pollingIntervalMs = 500;
    private int _highlightDisplayDurationMs = 3000;
    private int _lookbackSecondsOnStart = 3;
    private int _maxRowsPerPoll = 20;
    private bool _isPollingActive;
    private List<ZkDevice> _devices = new();

    private async Task OpenSettingsAsync()
    {
        await LoadSettingsAsync();
        _showSettingsModal = true;
    }

    private void CloseSettings() => _showSettingsModal = false;

    protected override async Task OnInitializedAsync()
    {
        _isPollingActive = PollingController.IsActive;
        PollingController.StatusChanged += OnPollingStatusChanged;

        _connectionString = Configuration.GetConnectionString("AccessControlDb") ?? string.Empty;
        _photosPath = Configuration.GetSection("PhotoOptions").GetValue<string>("PhotoDirectory") ?? string.Empty;
        _isLiveMode = Configuration.GetValue<bool>("IsLiveMode");
        _selectedDeviceSerial = Configuration.GetValue<string>("SelectedDeviceSerial") ?? string.Empty;
        _pollingIntervalMs = Configuration.GetValue("TurnstilePolling:IntervalsMs",
        Configuration.GetValue("TurnstilePolling:IntervalMs", 500));
        _highlightDisplayDurationMs = Configuration.GetValue("TurnstilePolling:HighlightDisplayDuration", 3000);
        _lookbackSecondsOnStart = Configuration.GetValue("TurnstilePolling:LookbackSecondsOntart",
        Configuration.GetValue("TurnstilePolling:LookbackSecondsOnStart", 3));
        _maxRowsPerPoll = Configuration.GetValue("TurnstilePolling:MaxRowsPerPoll", 20);

        await using var db = await DbFactory.CreateDbContextAsync();

        _devices = await db.ZkDevices
        .AsNoTracking()
        .OrderBy(d => d.Name)
        .ToListAsync();

        if (_devices.Count > 0)
        {
            if (string.IsNullOrWhiteSpace(_selectedDeviceSerial))
                _selectedDeviceSerial = _devices[0].SerialNumber;
            else if (_selectedDeviceSerial != AllDevicesValue && _devices.All(d => d.SerialNumber != _selectedDeviceSerial))
                _selectedDeviceSerial = _devices[0].SerialNumber;
        }
    }

    private async Task BrowsePhotosPathAsync()
    {
        try
        {
            var selectedPath = await JsRuntime.InvokeAsync<string>("sentryApp.selectFolder");
            if (!string.IsNullOrWhiteSpace(selectedPath))
                _photosPath = selectedPath;
        }
        catch (JSException)
        {
            Console.Error.WriteLine("Folder selection is not supported in this browser.");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
            await EnsureSelectedDeviceSerialInStorageAsync();
    }

    private async Task TogglePollingServiceAsync()
    {
        if (_isPollingActive)
        {
            PollingController.TryStop();
        }
        else
        {
            await EnsureSelectedDeviceSerialInStorageAsync();
            PollingController.TryStart();
        }

        _isPollingActive = PollingController.IsActive;
    }

    private async Task SaveSettingsAsync()
    {
        try
        {
            if (_isPollingActive)
                return;

            _pollingIntervalMs = Math.Max(1, _pollingIntervalMs);
            _highlightDisplayDurationMs = Math.Max(1, _highlightDisplayDurationMs);
            _lookbackSecondsOnStart = Math.Max(0, _lookbackSecondsOnStart);
            _maxRowsPerPoll = Math.Max(1, _maxRowsPerPoll);

            await UpdateAppSettingsAsync();
            await UpdateSelectedDeviceStorageAsync();
            EnsureSelectedDeviceSerialIsValid();

            _showSettingsModal = false;
            await InvokeAsync(StateHasChanged);
            await JsRuntime.InvokeVoidAsync("location.reload");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to save settings: {ex}");
        }
    }

    private async Task LoadSettingsAsync()
    {
        _isPollingActive = PollingController.IsActive;

        try
        {
            _connectionString = Configuration.GetConnectionString("AccessControlDb") ?? _connectionString;
            _photosPath = Configuration.GetSection("PhotoOptions").GetValue<string>("PhotoDirectory") ?? _photosPath;
            _isLiveMode = Configuration.GetValue("IsLiveMode", _isLiveMode);
            _selectedDeviceSerial = Configuration.GetValue<string>("SelectedDeviceSerial") ?? _selectedDeviceSerial;
            _pollingIntervalMs = Configuration.GetValue("TurnstilePolling:IntervalsMs",
            Configuration.GetValue("TurnstilePolling:IntervalMs", _pollingIntervalMs));
            _highlightDisplayDurationMs = Configuration.GetValue("TurnstilePolling:HighlightDisplayDuration",
            _highlightDisplayDurationMs);
            _lookbackSecondsOnStart = Configuration.GetValue("TurnstilePolling:LookbackSecondsOntart",
            Configuration.GetValue("TurnstilePolling:LookbackSecondsOnStart", _lookbackSecondsOnStart));
            _maxRowsPerPoll = Configuration.GetValue("TurnstilePolling:MaxRowsPerPoll", _maxRowsPerPoll);

            var appSettingsPath = Path.Combine(Environment.ContentRootPath, "appsettings.json");
            if (File.Exists(appSettingsPath))
            {
                var json = await File.ReadAllTextAsync(appSettingsPath);
                if (JsonNode.Parse(json) is JsonObject root)
                {
                    if (root["ConnectionStrings"] is JsonObject cs && TryReadJsonValue(cs["AccessControlDb"], out string? connectionString))
                        _connectionString = connectionString;

                    if (root["PhotoOptions"] is JsonObject photoOptions && TryReadJsonValue(photoOptions["PhotoDirectory"], out string?
                    photoDirectory))
                        _photosPath = photoDirectory;

                    if (TryReadJsonValue(root["IsLiveMode"], out bool liveMode))
                        _isLiveMode = liveMode;

                    if (TryReadJsonValue(root["SelectedDeviceSerial"], out string? deviceSerial))
                        _selectedDeviceSerial = deviceSerial;

                    if (root["TurnstilePolling"] is JsonObject turnstilePolling)
                    {
                        if (TryReadJsonValue(turnstilePolling["IntervalsMs"], out int interval))
                            _pollingIntervalMs = interval;

                        if (TryReadJsonValue(turnstilePolling["HighlightDisplayDuration"], out int highlightDisplayDuration))
                            _highlightDisplayDurationMs = highlightDisplayDuration;

                        if (TryReadJsonValue(turnstilePolling["LookbackSecondsOntart"], out int lookback))
                            _lookbackSecondsOnStart = lookback;

                        if (TryReadJsonValue(turnstilePolling["MaxRowsPerPoll"], out int maxRows))
                            _maxRowsPerPoll = maxRows;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load settings: {ex}");
        }

        await EnsureSelectedDeviceSerialInStorageAsync();

        if (_devices.Count > 0)
        {
            if (string.IsNullOrWhiteSpace(_selectedDeviceSerial))
                _selectedDeviceSerial = _devices[0].SerialNumber;
            else if (_selectedDeviceSerial != AllDevicesValue && _devices.All(d => d.SerialNumber != _selectedDeviceSerial))
                _selectedDeviceSerial = _devices[0].SerialNumber;
        }
    }

    private void OnPollingStatusChanged(bool isActive)
    {
        _isPollingActive = isActive;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        PollingController.StatusChanged -= OnPollingStatusChanged;
    }

    private async Task UpdateAppSettingsAsync()
    {
        var appSettingsPath = Path.Combine(Environment.ContentRootPath, "appsettings.json");
        if (!File.Exists(appSettingsPath))
            return;

        try
        {
            var json = await File.ReadAllTextAsync(appSettingsPath);
            var root = JsonNode.Parse(json) as JsonObject ?? new JsonObject();

            if (root["ConnectionStrings"] is not JsonObject connectionStrings)
            {
                connectionStrings = new JsonObject();
                root["ConnectionStrings"] = connectionStrings;
            }

            connectionStrings["AccessControlDb"] = _connectionString;

            root["PhotoOptions"] ??= new JsonObject();
            if (root["PhotoOptions"] is JsonObject photoOptions)
                photoOptions["PhotoDirectory"] = _photosPath;

            root["IsLiveMode"] = _isLiveMode;
            root["SelectedDeviceSerial"] = _selectedDeviceSerial;

            root["TurnstilePolling"] ??= new JsonObject();
            if (root["TurnstilePolling"] is JsonObject turnstilePolling)
            {
                turnstilePolling["IntervalsMs"] = _pollingIntervalMs;
                turnstilePolling["HighlightDisplayDuration"] = _highlightDisplayDurationMs;
                turnstilePolling["LookbackSecondsOntart"] = _lookbackSecondsOnStart;
                turnstilePolling["MaxRowsPerPoll"] = _maxRowsPerPoll;
            }

            await File.WriteAllTextAsync(appSettingsPath, root.ToJsonString(new JsonSerializerOptions
            {
                WriteIndented = true
            }));
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to update appsettings.json: {ex}");
        }
    }

    private async Task EnsureSelectedDeviceSerialInStorageAsync()
    {
        try
        {
            var storedSerial = await JsRuntime.InvokeAsync<string?>("localStorage.getItem", SelectedDeviceStorageKey);
            if (string.IsNullOrWhiteSpace(storedSerial))
            {
                _selectedDeviceSerial = AllDevicesValue;
                await JsRuntime.InvokeVoidAsync("localStorage.setItem", SelectedDeviceStorageKey, _selectedDeviceSerial);
            }
            else
            {
                _selectedDeviceSerial = storedSerial;
            }
        }
        catch (JSException)
        {
            if (string.IsNullOrWhiteSpace(_selectedDeviceSerial))
                _selectedDeviceSerial = AllDevicesValue;
        }

        EnsureSelectedDeviceSerialIsValid();
    }

    private async Task UpdateSelectedDeviceStorageAsync()
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("localStorage.setItem", SelectedDeviceStorageKey, _selectedDeviceSerial);
        }
        catch (JSException)
        {
            Console.Error.WriteLine("Local storage is not available.");
        }
    }

    private static bool TryReadJsonValue<T>(JsonNode? node, out T value)
    {
        if (node is JsonValue jsonValue)
        {
            try
            {
                value = jsonValue.GetValue<T>();
                return true;
            }
            catch
            {
                // ignored - will fall through to default
            }
        }

        value = default!;
        return false;
    }

    private string LiveButtonLabel => !_isPollingActive
    ? "Halted"
    : _isLiveMode ? "Live Feed" : "Demo";

    private string LiveButtonClass
    {
        get
        {
            if (!_isPollingActive)
                return "mon-live-btn btn btn-secondary";

            if (_isLiveMode)
                return "mon-live-btn";

            return "mon-live-btn btn btn-warning";
        }
    }

    private void EnsureSelectedDeviceSerialIsValid()
    {
        if (_devices.Count == 0)
            return;

        if (string.IsNullOrWhiteSpace(_selectedDeviceSerial))
            _selectedDeviceSerial = _devices[0].SerialNumber;
        else if (_selectedDeviceSerial != AllDevicesValue && _devices.All(d => d.SerialNumber != _selectedDeviceSerial))
            _selectedDeviceSerial = _devices[0].SerialNumber;
    }

    private string MonitoringTitle
    {
        get
        {
            if (_selectedDeviceSerial == AllDevicesValue)
                return "ALL DEVICES MONITORING";

            var deviceName = _devices.FirstOrDefault(d => d.SerialNumber == _selectedDeviceSerial)?.Name;
            if (!string.IsNullOrWhiteSpace(deviceName))
                return $"{deviceName.ToUpperInvariant()} MONITORING";

            return "GATE 1 MONITORING";
        }
    }
}
