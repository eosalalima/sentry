@using Microsoft.EntityFrameworkCore
@using Microsoft.Extensions.Configuration
@using Microsoft.AspNetCore.Hosting
@using System.Linq
@using System.Text
@using System.Text.Json
@using System.Text.Json.Nodes
@using System.IO.Ports
@using System.Threading
@using SentryApp.Data
@using SentryApp.Data.Query
@using SentryApp.Services
@implements IDisposable

<div class="mon-header">
    <div class="mon-brand">
        <img class="mon-logo" src="/img/logo.png" alt="Logo" />
        <div>
            <div class="mon-title">@MonitoringTitle</div>
            <div class="mon-subtitle"><strong>DR. GLORIA D. LACSON FOUNDATION COLLEGES</strong></div>
        </div>
    </div>

    <div>
        <button class="@LiveButtonClass" type="button">@LiveButtonLabel</button>
        <button class="btn btn-link" type="button" @onclick="TogglePollingServiceAsync"
            tooltip="Start/Stop Polling Service">
            @if (_isPollingActive)
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-stop-fill"
                    viewBox="0 0 16 16">
                    <path
                        d="M5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5A1.5 1.5 0 0 1 5 3.5" />
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-play-fill"
                    viewBox="0 0 16 16">
                    <path
                        d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393" />
                </svg>
            }
        </button>
        <button class="btn btn-link" type="button" @onclick="OpenSettingsAsync">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" class="bi bi-gear"
                viewBox="0 0 16 16">
                <path
                    d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0" />
                <path
                    d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z" />
            </svg>
        </button>
    </div>
</div>

@if (_showSettingsModal)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Monitoring Settings</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseSettings"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="connectionString">Database connection string</label>
                        <input class="form-control" id="connectionString" type="text" @bind="_connectionString"
                            placeholder="Server=...;Database=...;" disabled="@_isPollingActive" />
                    </div>

                    <div class="form-check form-switch mt-3 mb-3">
                        <input class="form-check-input" id="liveMode" type="checkbox" role="switch" @bind="_isLiveMode"
                            disabled="@_isPollingActive" />
                        <label class="form-check-label" for="liveMode">Live mode</label>
                        <div class="form-text">Toggle off to switch to demo mode.</div>
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="deviceSelect">Device to monitor</label>
                        <select class="form-select" id="deviceSelect" @bind="_selectedDeviceSerial"
                            disabled="@_isPollingActive">
                            @if (_devices.Count == 0)
                            {
                                <option disabled value="">No devices available</option>
                            }
                            else
                            {
                                <option value="@AllDevicesValue">All Devices</option>
                                @foreach (var device in _devices)
                                {
                                    <option value="@device.SerialNumber">@device.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="smsComPort">SMS module COM port number</label>
                        <div class="input-group">
                            <input class="form-control" id="smsComPort" type="number" min="1" step="1"
                                @bind-value="_smsComPortNumber" @bind-value:event="oninput" disabled="@_isPollingActive"
                                placeholder="e.g. 3" />
                            <button class="btn btn-outline-secondary" type="button" @onclick="OpenSmsTestModal"
                                disabled="@_isPollingActive">Send test message</button>
                            <button class="btn btn-outline-secondary" type="button" @onclick="OpenSmsConfigModal"
                                disabled="@_isPollingActive">SMS Config</button>
                        </div>
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="photosPath">Photos path</label>
                        <div class="input-group">
                            <input class="form-control" id="photosPath" type="text" @bind="_photosPath"
                                placeholder="C:\\Photos\\..." disabled="@_isPollingActive" />
                            <button class="btn btn-outline-secondary" type="button" @onclick="BrowsePhotosPathAsync"
                                disabled="@_isPollingActive">Browse</button>
                        </div>
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="pollInterval">Polling interval (ms)</label>
                        <input class="form-control" id="pollInterval" type="number" min="1" step="1"
                            @bind-value="_pollingIntervalMs" @bind-value:event="oninput" disabled="@_isPollingActive" />
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="highlightDuration">Highlight Display Duration (ms)</label>
                        <input class="form-control" id="highlightDuration" type="number" min="1" step="1"
                            @bind-value="_highlightDisplayDurationMs" @bind-value:event="oninput"
                            disabled="@_isPollingActive" />
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="lookbackSeconds">Lookback seconds on start</label>
                        <input class="form-control" id="lookbackSeconds" type="number" min="0" step="1"
                            @bind-value="_lookbackSecondsOnStart" @bind-value:event="oninput"
                            disabled="@_isPollingActive" />
                    </div>

                    <div class="mt-3 mb-3">
                        <label class="form-label" for="maxRowsPerPoll">Max rows per poll</label>
                        <input class="form-control" id="maxRowsPerPoll" type="number" min="1" step="1"
                            @bind-value="_maxRowsPerPoll" @bind-value:event="oninput" disabled="@_isPollingActive" />
                    </div>
                </div>

                <div class="modal-footer">
                    @* <button class="btn @(_isPollingActive ? "btn-danger" : "btn-success") me-auto" type="button"
                        @onclick="TogglePollingServiceAsync">@(_isPollingActive ? "Stop Service" : "Run Service")</button> *@
                    <button class="btn btn-primary" type="button" @onclick="SaveSettingsAsync"
                        disabled="@_isPollingActive">Save</button>
                    <button class="btn btn-secondary" type="button" @onclick="CloseSettings">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" @onclick="CloseSettings"></div>
}

@if (_showSmsTestModal)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Send Test Message</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseSmsTestModal"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label" for="smsTestNumber">Mobile number</label>
                        <input class="form-control" id="smsTestNumber" type="tel" @bind="_smsTestMobileNumber"
                            placeholder="+63..." />
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="smsTestMessage">Message</label>
                        <textarea class="form-control" id="smsTestMessage" rows="4" @bind="_smsTestMessage"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" @onclick="SendTestSmsAsync"
                        disabled="@_isSendingSmsTest">Send</button>
                    <button class="btn btn-secondary" type="button" @onclick="CloseSmsTestModal"
                        disabled="@_isSendingSmsTest">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" @onclick="CloseSmsTestModal"></div>
}

@if (_showSmsConfigModal)
{
    <div class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">SMS Device Configuration</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseSmsConfigModal"></button>
                </div>

                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigComPort">Serial Port Number (COM)</label>
                            <input class="form-control" id="smsConfigComPort" type="number" min="1" step="1"
                                @bind-value="_smsComPortNumber" @bind-value:event="oninput"
                                disabled="@_isPollingActive" placeholder="e.g. 4" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigBaudRate">Baud rate</label>
                            <input class="form-control" id="smsConfigBaudRate" type="number" min="1" step="1"
                                @bind-value="_smsBaudRate" @bind-value:event="oninput" disabled="@_isPollingActive" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigDataBits">Data bits</label>
                            <input class="form-control" id="smsConfigDataBits" type="number" min="5" step="1"
                                @bind-value="_smsDataBits" @bind-value:event="oninput" disabled="@_isPollingActive" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigParity">Parity</label>
                            <select class="form-select" id="smsConfigParity" @bind="_smsParity"
                                disabled="@_isPollingActive">
                                @foreach (var option in SmsParityOptions)
                                {
                                    <option value="@option">@option</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigStopBits">StopBits</label>
                            <select class="form-select" id="smsConfigStopBits" @bind="_smsStopBits"
                                disabled="@_isPollingActive">
                                @foreach (var option in SmsStopBitsOptions)
                                {
                                    <option value="@option">@option</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigHandshake">Handshake</label>
                            <select class="form-select" id="smsConfigHandshake" @bind="_smsHandshake"
                                disabled="@_isPollingActive">
                                @foreach (var option in SmsHandshakeOptions)
                                {
                                    <option value="@option">@option</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigReadTimeout">ReadTimeout (ms)</label>
                            <input class="form-control" id="smsConfigReadTimeout" type="number" min="1" step="1"
                                @bind-value="_smsReadTimeoutMs" @bind-value:event="oninput"
                                disabled="@_isPollingActive" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="smsConfigWriteTimeout">WriteTimeout (ms)</label>
                            <input class="form-control" id="smsConfigWriteTimeout" type="number" min="1" step="1"
                                @bind-value="_smsWriteTimeoutMs" @bind-value:event="oninput"
                                disabled="@_isPollingActive" />
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="smsConfigNewLine">NewLine character</label>
                            <input class="form-control" id="smsConfigNewLine" type="text" @bind="SmsNewLineDisplay"
                                disabled="@_isPollingActive" placeholder="\\r\\n" />
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="smsConfigMessageFormat">Message format</label>
                            <textarea class="form-control" id="smsConfigMessageFormat" rows="4"
                                @bind="_smsMessageFormat" disabled="@_isPollingActive"
                                placeholder="@DefaultSmsMessageFormat"></textarea>
                            <div class="form-text">
                                Use placeholders like {PERSONNEL.LASTNAME}, {PERSONNEL.FIRSTNAME}, {IN or OUT},
                                {LOGDATE=DATEFORMAT:dd-MMM-yyyy}, {LOGTIME=TIMEFORMAT:hh:mm tt}.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary" type="button" @onclick="SaveSmsConfigAsync"
                        disabled="@_isPollingActive">Save</button>
                    <button class="btn btn-secondary" type="button" @onclick="CloseSmsConfigModal"
                        disabled="@_isPollingActive">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" @onclick="CloseSmsConfigModal"></div>
}

@if (_showToast)
{
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div class="toast align-items-center text-bg-@_toastVariant border-0 show" role="alert" aria-live="assertive"
            aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">@_toastMessage</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" aria-label="Close"
                    @onclick="HideToast"></button>
            </div>
        </div>
    </div>
}

@code {
    [Inject]
    private IDbContextFactory<AccessControlDbContext> DbFactory { get; set; } = default!;

    [Inject]
    private IConfiguration Configuration { get; set; } = default!;

    [Inject]
    private IJSRuntime JsRuntime { get; set; } = default!;

    [Inject]
    private IWebHostEnvironment Environment { get; set; } = default!;

    [Inject]
    private TurnstilePollingController PollingController { get; set; } = default!;

    private const string AllDevicesValue = "1";
    private const string SelectedDeviceSerialStorageKey = "SelectedDeviceSerial";

    private bool _showSettingsModal;
    private string _connectionString = string.Empty;
    private bool _isLiveMode = true;
    private string _selectedDeviceSerial = string.Empty;
    private string _photosPath = string.Empty;
    private int _pollingIntervalMs = 500;
    private int _highlightDisplayDurationMs = 3000;
    private int _lookbackSecondsOnStart = 3;
    private int _maxRowsPerPoll = 20;
    private int _smsComPortNumber = 1;
    private int _smsBaudRate = 9600;
    private int _smsDataBits = 8;
    private string _smsParity = Parity.None.ToString();
    private string _smsStopBits = StopBits.One.ToString();
    private string _smsHandshake = Handshake.None.ToString();
    private int _smsReadTimeoutMs = 2000;
    private int _smsWriteTimeoutMs = 2000;
    private string _smsNewLine = "\r\n";
    private string _smsMessageFormat = DefaultSmsMessageFormat;
    private bool _isPollingActive;
    private List<ZkDevice> _devices = new();
    private bool _showToast;
    private string _toastMessage = string.Empty;
    private string _toastVariant = "info";
    private CancellationTokenSource? _toastCts;
    private bool _showSmsTestModal;
    private string _smsTestMobileNumber = string.Empty;
    private string _smsTestMessage = string.Empty;
    private bool _isSendingSmsTest;
    private bool _showSmsConfigModal;

    private static readonly string[] SmsParityOptions = { "None", "Odd", "Even", "Mark", "Space" };
    private static readonly string[] SmsStopBitsOptions = { "None", "One", "OnePointFive", "Two" };
    private static readonly string[] SmsHandshakeOptions =
    {
        "None",
        "XOnXOff",
        "RequestToSend",
        "RequestToSendXOnXOff"
    };
    private const string DefaultSmsMessageFormat =
        "{PERSONNEL.LASTNAME}, {PERSONNEL.FIRSTNAME} has {IN or OUT} on {LOGDATE=DATEFORMAT:dd-MMM-yyyy} {LOGTIME=TIMEFORMAT:hh:mm tt} * Auto-generated SMS - do not reply";

    private async Task OpenSettingsAsync()
    {
        await LoadSettingsAsync();
        _showSettingsModal = true;
    }

    private void CloseSettings() => _showSettingsModal = false;

    protected override async Task OnInitializedAsync()
    {
        _isPollingActive = PollingController.IsActive;
        PollingController.StatusChanged += OnPollingStatusChanged;

        _connectionString = Configuration.GetConnectionString("AccessControlDb") ?? string.Empty;
        _photosPath = Configuration.GetSection("PhotoOptions").GetValue<string>("PhotoDirectory") ?? string.Empty;
        _isLiveMode = Configuration.GetValue<bool>("IsLiveMode");
        _selectedDeviceSerial = Configuration.GetValue<string>("SelectedDeviceSerial") ?? string.Empty;
        _pollingIntervalMs = Configuration.GetValue("TurnstilePolling:IntervalsMs",
        Configuration.GetValue("TurnstilePolling:IntervalMs", 500));
        _highlightDisplayDurationMs = Configuration.GetValue("TurnstilePolling:HighlightDisplayDuration", 3000);
        _lookbackSecondsOnStart = Configuration.GetValue("TurnstilePolling:LookbackSecondsOntart",
        Configuration.GetValue("TurnstilePolling:LookbackSecondsOnStart", 3));
        _maxRowsPerPoll = Configuration.GetValue("TurnstilePolling:MaxRowsPerPoll", 20);
        _smsComPortNumber = Configuration.GetValue("SmsModule:ComPort", 1);
        _smsBaudRate = Configuration.GetValue("SmsModule:BaudRate", 9600);
        _smsDataBits = Configuration.GetValue("SmsModule:DataBits", 8);
        _smsParity = Configuration.GetValue("SmsModule:Parity", Parity.None.ToString());
        _smsStopBits = Configuration.GetValue("SmsModule:StopBits", StopBits.One.ToString());
        _smsHandshake = Configuration.GetValue("SmsModule:Handshake", Handshake.None.ToString());
        _smsReadTimeoutMs = Configuration.GetValue("SmsModule:ReadTimeout", 2000);
        _smsWriteTimeoutMs = Configuration.GetValue("SmsModule:WriteTimeout", 2000);
        _smsNewLine = Configuration.GetValue("SmsModule:NewLine", "\r\n");
        _smsMessageFormat = Configuration.GetValue("SmsModule:MessageFormat", DefaultSmsMessageFormat);

        await using var db = await DbFactory.CreateDbContextAsync();

        _devices = await db.ZkDevices
        .AsNoTracking()
        .OrderBy(d => d.Name)
        .ToListAsync();

        NormalizeSelectedDeviceSerial();
    }

    private async Task BrowsePhotosPathAsync()
    {
        try
        {
            var selectedPath = await JsRuntime.InvokeAsync<string>("sentryApp.selectFolder");
            if (!string.IsNullOrWhiteSpace(selectedPath))
                _photosPath = selectedPath;
        }
        catch (JSException)
        {
            Console.Error.WriteLine("Folder selection is not supported in this browser.");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;

        await EnsureSelectedDeviceSerialAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task TogglePollingServiceAsync()
    {
        if (_isPollingActive)
        {
            PollingController.TryStop();
        }
        else
        {
            await EnsureSelectedDeviceSerialAsync();
            PollingController.TryStart();
        }

        _isPollingActive = PollingController.IsActive;
    }

    private async Task SaveSettingsAsync()
    {
        try
        {
            if (_isPollingActive)
                return;

            _pollingIntervalMs = Math.Max(1, _pollingIntervalMs);
            _highlightDisplayDurationMs = Math.Max(1, _highlightDisplayDurationMs);
            _lookbackSecondsOnStart = Math.Max(0, _lookbackSecondsOnStart);
            _maxRowsPerPoll = Math.Max(1, _maxRowsPerPoll);
            _smsComPortNumber = Math.Max(1, _smsComPortNumber);
            _selectedDeviceSerial = string.IsNullOrWhiteSpace(_selectedDeviceSerial)
            ? AllDevicesValue
            : _selectedDeviceSerial;

            await SetSelectedDeviceSerialAsync(_selectedDeviceSerial);

            await UpdateAppSettingsAsync();
            EnsureSelectedDeviceSerialIsValid();

            _showSettingsModal = false;
            await InvokeAsync(StateHasChanged);
            await JsRuntime.InvokeVoidAsync("location.reload");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to save settings: {ex}");
        }
    }

    private void OpenSmsTestModal()
    {
        _smsTestMobileNumber = string.Empty;
        _smsTestMessage = string.Empty;
        _showSmsTestModal = true;
    }

    private void CloseSmsTestModal() => _showSmsTestModal = false;

    private void OpenSmsConfigModal() => _showSmsConfigModal = true;

    private void CloseSmsConfigModal() => _showSmsConfigModal = false;

    private async Task SaveSmsConfigAsync()
    {
        if (_isPollingActive)
            return;

        NormalizeSmsModuleSettings();

        await UpdateSmsModuleSettingsAsync();
        _showSmsConfigModal = false;
        await ShowToastAsync("SMS module settings saved.", "success");
    }

    private async Task SendTestSmsAsync()
    {
        if (_isSendingSmsTest)
            return;

        if (_smsComPortNumber < 1)
        {
            await ShowToastAsync("Please enter a valid COM port number.", "danger");
            return;
        }

        if (string.IsNullOrWhiteSpace(_smsTestMobileNumber))
        {
            await ShowToastAsync("Please provide a mobile number.", "danger");
            return;
        }

        if (string.IsNullOrWhiteSpace(_smsTestMessage))
        {
            await ShowToastAsync("Please enter a message to send.", "danger");
            return;
        }

        NormalizeSmsModuleSettings();

        _isSendingSmsTest = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            var portName = $"COM{_smsComPortNumber}";
            if (!SerialPort.GetPortNames().Any(port => string.Equals(port, portName, StringComparison.OrdinalIgnoreCase)))
            {
                await ShowToastAsync($"No device detected on {portName}.", "danger");
                return;
            }

            var smsSettings = BuildSmsModuleSettings();
            var result = await Task.Run(() => SendSms(portName, _smsTestMobileNumber, _smsTestMessage, smsSettings));

            if (result.Success)
            {
                _showSmsTestModal = false;
                await ShowToastAsync("Test message sent successfully.", "success");
            }
            else
            {
                await ShowToastAsync(result.Response + " (Failed to send test message)", "danger");
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to send test message: {ex}");
            await ShowToastAsync($"Failed to send test message: {ex.Message}", "danger");
        }
        finally
        {
            _isSendingSmsTest = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadSettingsAsync()
    {
        _isPollingActive = PollingController.IsActive;

        try
        {
            _connectionString = Configuration.GetConnectionString("AccessControlDb") ?? _connectionString;
            _photosPath = Configuration.GetSection("PhotoOptions").GetValue<string>("PhotoDirectory") ?? _photosPath;
            _isLiveMode = Configuration.GetValue("IsLiveMode", _isLiveMode);
            _selectedDeviceSerial = Configuration.GetValue<string>("SelectedDeviceSerial") ?? _selectedDeviceSerial;
            _pollingIntervalMs = Configuration.GetValue("TurnstilePolling:IntervalsMs",
            Configuration.GetValue("TurnstilePolling:IntervalMs", _pollingIntervalMs));
            _highlightDisplayDurationMs = Configuration.GetValue("TurnstilePolling:HighlightDisplayDuration",
            _highlightDisplayDurationMs);
            _lookbackSecondsOnStart = Configuration.GetValue("TurnstilePolling:LookbackSecondsOntart",
            Configuration.GetValue("TurnstilePolling:LookbackSecondsOnStart", _lookbackSecondsOnStart));
            _maxRowsPerPoll = Configuration.GetValue("TurnstilePolling:MaxRowsPerPoll", _maxRowsPerPoll);
            _smsComPortNumber = Configuration.GetValue("SmsModule:ComPort", _smsComPortNumber);
            _smsBaudRate = Configuration.GetValue("SmsModule:BaudRate", _smsBaudRate);
            _smsDataBits = Configuration.GetValue("SmsModule:DataBits", _smsDataBits);
            _smsParity = Configuration.GetValue("SmsModule:Parity", _smsParity);
            _smsStopBits = Configuration.GetValue("SmsModule:StopBits", _smsStopBits);
            _smsHandshake = Configuration.GetValue("SmsModule:Handshake", _smsHandshake);
            _smsReadTimeoutMs = Configuration.GetValue("SmsModule:ReadTimeout", _smsReadTimeoutMs);
            _smsWriteTimeoutMs = Configuration.GetValue("SmsModule:WriteTimeout", _smsWriteTimeoutMs);
            _smsNewLine = Configuration.GetValue("SmsModule:NewLine", _smsNewLine);
            _smsMessageFormat = Configuration.GetValue("SmsModule:MessageFormat", _smsMessageFormat);

            var appSettingsPath = Path.Combine(Environment.ContentRootPath, "appsettings.json");
            if (File.Exists(appSettingsPath))
            {
                var json = await File.ReadAllTextAsync(appSettingsPath);
                if (JsonNode.Parse(json) is JsonObject root)
                {
                    if (root["ConnectionStrings"] is JsonObject cs && TryReadJsonValue(cs["AccessControlDb"], out string? connectionString)
                    && connectionString != null)
                        _connectionString = connectionString;

                    if (root["PhotoOptions"] is JsonObject photoOptions && TryReadJsonValue(photoOptions["PhotoDirectory"], out string?
                    photoDirectory) && photoDirectory != null)
                        _photosPath = photoDirectory;

                    if (TryReadJsonValue(root["IsLiveMode"], out bool liveMode))
                        _isLiveMode = liveMode;

                    if (TryReadJsonValue(root["SelectedDeviceSerial"], out string? deviceSerial) && deviceSerial != null)
                        _selectedDeviceSerial = deviceSerial;

                    if (root["TurnstilePolling"] is JsonObject turnstilePolling)
                    {
                        if (TryReadJsonValue(turnstilePolling["IntervalsMs"], out int interval))
                            _pollingIntervalMs = interval;

                        if (TryReadJsonValue(turnstilePolling["HighlightDisplayDuration"], out int highlightDisplayDuration))
                            _highlightDisplayDurationMs = highlightDisplayDuration;

                        if (TryReadJsonValue(turnstilePolling["LookbackSecondsOntart"], out int lookback))
                            _lookbackSecondsOnStart = lookback;

                        if (TryReadJsonValue(turnstilePolling["MaxRowsPerPoll"], out int maxRows))
                            _maxRowsPerPoll = maxRows;
                    }

                    if (root["SmsModule"] is JsonObject smsModule)
                    {
                        if (TryReadJsonValue(smsModule["ComPort"], out int comPort))
                            _smsComPortNumber = comPort;
                        if (TryReadJsonValue(smsModule["BaudRate"], out int baudRate))
                            _smsBaudRate = baudRate;
                        if (TryReadJsonValue(smsModule["DataBits"], out int dataBits))
                            _smsDataBits = dataBits;
                        if (TryReadJsonValue(smsModule["Parity"], out string? parity) && parity != null)
                            _smsParity = parity;
                        if (TryReadJsonValue(smsModule["StopBits"], out string? stopBits) && stopBits != null)
                            _smsStopBits = stopBits;
                        if (TryReadJsonValue(smsModule["Handshake"], out string? handshake) && handshake != null)
                            _smsHandshake = handshake;
                        if (TryReadJsonValue(smsModule["ReadTimeout"], out int readTimeout))
                            _smsReadTimeoutMs = readTimeout;
                        if (TryReadJsonValue(smsModule["WriteTimeout"], out int writeTimeout))
                            _smsWriteTimeoutMs = writeTimeout;
                        if (TryReadJsonValue(smsModule["NewLine"], out string? newLine) && newLine != null)
                            _smsNewLine = newLine;
                        if (TryReadJsonValue(smsModule["MessageFormat"], out string? messageFormat)
                        && messageFormat != null)
                            _smsMessageFormat = messageFormat;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to load settings: {ex}");
        }

        var storedSerial = await GetSelectedDeviceSerialAsync();
        if (!string.IsNullOrWhiteSpace(storedSerial))
            _selectedDeviceSerial = storedSerial;

        NormalizeSelectedDeviceSerial();
    }

    private void OnPollingStatusChanged(bool isActive)
    {
        _isPollingActive = isActive;
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        PollingController.StatusChanged -= OnPollingStatusChanged;
    }

    private async Task UpdateAppSettingsAsync()
    {
        var appSettingsPath = Path.Combine(Environment.ContentRootPath, "appsettings.json");
        if (!File.Exists(appSettingsPath))
            return;

        try
        {
            var json = await File.ReadAllTextAsync(appSettingsPath);
            var root = JsonNode.Parse(json) as JsonObject ?? new JsonObject();

            if (root["ConnectionStrings"] is not JsonObject connectionStrings)
            {
                connectionStrings = new JsonObject();
                root["ConnectionStrings"] = connectionStrings;
            }

            connectionStrings["AccessControlDb"] = _connectionString;

            root["PhotoOptions"] ??= new JsonObject();
            if (root["PhotoOptions"] is JsonObject photoOptions)
                photoOptions["PhotoDirectory"] = _photosPath;

            root["IsLiveMode"] = _isLiveMode;
            root["SelectedDeviceSerial"] = _selectedDeviceSerial;

            root["TurnstilePolling"] ??= new JsonObject();
            if (root["TurnstilePolling"] is JsonObject turnstilePolling)
            {
                turnstilePolling["IntervalsMs"] = _pollingIntervalMs;
                turnstilePolling["HighlightDisplayDuration"] = _highlightDisplayDurationMs;
                turnstilePolling["LookbackSecondsOntart"] = _lookbackSecondsOnStart;
                turnstilePolling["MaxRowsPerPoll"] = _maxRowsPerPoll;
            }

            root["SmsModule"] ??= new JsonObject();
            if (root["SmsModule"] is JsonObject smsModule)
                smsModule["ComPort"] = _smsComPortNumber;

            await File.WriteAllTextAsync(appSettingsPath, root.ToJsonString(new JsonSerializerOptions
            {
                WriteIndented = true
            }));
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to update appsettings.json: {ex}");
        }
    }

    private async Task UpdateSmsModuleSettingsAsync()
    {
        var appSettingsPath = Path.Combine(Environment.ContentRootPath, "appsettings.json");
        if (!File.Exists(appSettingsPath))
            return;

        try
        {
            var json = await File.ReadAllTextAsync(appSettingsPath);
            var root = JsonNode.Parse(json) as JsonObject ?? new JsonObject();

            root["SmsModule"] ??= new JsonObject();
            if (root["SmsModule"] is JsonObject smsModule)
            {
                smsModule["ComPort"] = _smsComPortNumber;
                smsModule["BaudRate"] = _smsBaudRate;
                smsModule["DataBits"] = _smsDataBits;
                smsModule["Parity"] = _smsParity;
                smsModule["StopBits"] = _smsStopBits;
                smsModule["Handshake"] = _smsHandshake;
                smsModule["ReadTimeout"] = _smsReadTimeoutMs;
                smsModule["WriteTimeout"] = _smsWriteTimeoutMs;
                smsModule["NewLine"] = _smsNewLine;
                smsModule["MessageFormat"] = _smsMessageFormat;
            }

            await File.WriteAllTextAsync(appSettingsPath, root.ToJsonString(new JsonSerializerOptions
            {
                WriteIndented = true
            }));
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Failed to update SMS module settings: {ex}");
        }
    }

    private async Task<string?> GetSelectedDeviceSerialAsync()
    {
        try
        {
            return await JsRuntime.InvokeAsync<string?>("sentryApp.getLocalStorage", SelectedDeviceSerialStorageKey);
        }
        catch (JSException)
        {
            return null;
        }
    }

    private async Task SetSelectedDeviceSerialAsync(string value)
    {
        try
        {
            await JsRuntime.InvokeVoidAsync("sentryApp.setLocalStorage", SelectedDeviceSerialStorageKey, value);
        }
        catch (JSException)
        {
            // ignore local storage failures
        }
    }

    private async Task EnsureSelectedDeviceSerialAsync()
    {
        string? storedSerial;

        try
        {
            storedSerial = await JsRuntime.InvokeAsync<string>(
            "sentryApp.ensureLocalStorageValue",
            SelectedDeviceSerialStorageKey,
            AllDevicesValue);
        }
        catch (JSException)
        {
            storedSerial = null;
        }

        _selectedDeviceSerial = string.IsNullOrWhiteSpace(storedSerial)
        ? AllDevicesValue
        : storedSerial;

        NormalizeSelectedDeviceSerial();
        await SetSelectedDeviceSerialAsync(_selectedDeviceSerial);
    }

    private void NormalizeSelectedDeviceSerial()
    {
        if (_devices.Count == 0)
            return;

        if (string.IsNullOrWhiteSpace(_selectedDeviceSerial))
        {
            _selectedDeviceSerial = _devices[0].SerialNumber;
            return;
        }

        if (_selectedDeviceSerial != AllDevicesValue && _devices.All(d => d.SerialNumber != _selectedDeviceSerial))
            _selectedDeviceSerial = _devices[0].SerialNumber;
    }

    private async Task ShowToastAsync(string message, string variant)
    {
        _toastCts?.Cancel();
        _toastCts = new CancellationTokenSource();

        _toastMessage = message;
        _toastVariant = variant;
        _showToast = true;
        await InvokeAsync(StateHasChanged);

        try
        {
            await Task.Delay(TimeSpan.FromSeconds(4), _toastCts.Token);
            HideToast();
        }
        catch (TaskCanceledException)
        {
            // ignored
        }
    }

    private void HideToast()
    {
        _toastCts?.Cancel();
        _showToast = false;
        InvokeAsync(StateHasChanged);
    }

    private static SmsSendResult SendSms(string portName, string mobileNumber, string message, SmsModuleSettings settings)
    {
        using var port = new SerialPort(portName, settings.BaudRate, settings.Parity, settings.DataBits,
        settings.StopBits)
        {
            Handshake = settings.Handshake,
            ReadTimeout = settings.ReadTimeout,
            WriteTimeout = settings.WriteTimeout,
            NewLine = settings.NewLine
        };

        try
        {
            port.Open();
            SendCommand(port, "AT");
            SendCommand(port, "AT+CMGF=1");
            SendCommand(port, "AT+CMEE=1");

            port.WriteLine($"AT+CMGS=\"{mobileNumber}\"");
            var prompt = ReadUntilPrompt(port);
            if (prompt.Contains("ERROR", StringComparison.OrdinalIgnoreCase))
            {
                return new SmsSendResult(false, prompt);
            }

            port.Write(message + char.ConvertFromUtf32(26));
            var response = ReadResponse(port);
            var success = response.Contains("OK", StringComparison.OrdinalIgnoreCase);
            return new SmsSendResult(success, response);
        }
        catch (Exception ex)
        {
            return new SmsSendResult(false, $"SMS send failed: {ex.Message}");
        }
    }

    private static string SendCommand(SerialPort port, string command)
    {
        port.WriteLine(command);
        return ReadResponse(port);
    }

    private static string ReadResponse(SerialPort port)
    {
        var buffer = new StringBuilder();
        var stopAt = DateTime.UtcNow.AddMilliseconds(port.ReadTimeout);

        while (DateTime.UtcNow < stopAt)
        {
            try
            {
                var chunk = port.ReadExisting();
                if (!string.IsNullOrEmpty(chunk))
                {
                    buffer.Append(chunk);
                    if (buffer.ToString().Contains("OK", StringComparison.OrdinalIgnoreCase) ||
                    buffer.ToString().Contains("ERROR", StringComparison.OrdinalIgnoreCase))
                    {
                        break;
                    }
                }
            }
            catch (TimeoutException)
            {
                break;
            }

            Thread.Sleep(100);
        }

        return buffer.Length == 0 ? "No response received." : buffer.ToString();
    }

    private static string ReadUntilPrompt(SerialPort port)
    {
        var buffer = new StringBuilder();
        var stopAt = DateTime.UtcNow.AddMilliseconds(port.ReadTimeout);

        while (DateTime.UtcNow < stopAt)
        {
            try
            {
                var chunk = port.ReadExisting();
                if (!string.IsNullOrEmpty(chunk))
                {
                    buffer.Append(chunk);
                    var current = buffer.ToString();
                    if (current.Contains(">", StringComparison.OrdinalIgnoreCase) ||
                    current.Contains("ERROR", StringComparison.OrdinalIgnoreCase))
                    {
                        break;
                    }
                }
            }
            catch (TimeoutException)
            {
                break;
            }

            Thread.Sleep(100);
        }

        return buffer.Length == 0 ? "No response received." : buffer.ToString();
    }

    private SmsModuleSettings BuildSmsModuleSettings()
    {
        return new SmsModuleSettings(
            Math.Max(1, _smsBaudRate),
            Math.Max(5, _smsDataBits),
            ParseSmsParity(_smsParity),
            ParseSmsStopBits(_smsStopBits),
            ParseSmsHandshake(_smsHandshake),
            Math.Max(1, _smsReadTimeoutMs),
            Math.Max(1, _smsWriteTimeoutMs),
            string.IsNullOrWhiteSpace(_smsNewLine) ? "\r\n" : _smsNewLine);
    }

    private void NormalizeSmsModuleSettings()
    {
        _smsComPortNumber = Math.Max(1, _smsComPortNumber);
        _smsBaudRate = Math.Max(1, _smsBaudRate);
        _smsDataBits = Math.Max(5, _smsDataBits);
        _smsReadTimeoutMs = Math.Max(1, _smsReadTimeoutMs);
        _smsWriteTimeoutMs = Math.Max(1, _smsWriteTimeoutMs);
        _smsParity = SmsParityOptions.Contains(_smsParity, StringComparer.OrdinalIgnoreCase)
        ? _smsParity
        : Parity.None.ToString();
        _smsStopBits = SmsStopBitsOptions.Contains(_smsStopBits, StringComparer.OrdinalIgnoreCase)
        ? _smsStopBits
        : StopBits.One.ToString();
        _smsHandshake = SmsHandshakeOptions.Contains(_smsHandshake, StringComparer.OrdinalIgnoreCase)
        ? _smsHandshake
        : Handshake.None.ToString();
        _smsNewLine = string.IsNullOrWhiteSpace(_smsNewLine) ? "\r\n" : _smsNewLine;
        _smsMessageFormat = string.IsNullOrWhiteSpace(_smsMessageFormat)
        ? DefaultSmsMessageFormat
        : _smsMessageFormat;
    }

    private string SmsNewLineDisplay
    {
        get => _smsNewLine.Replace("\r", "\\r").Replace("\n", "\\n");
        set => _smsNewLine = InterpretEscapeSequences(value);
    }

    private static string InterpretEscapeSequences(string value)
    {
        if (string.IsNullOrEmpty(value))
            return "\r\n";

        return value.Replace("\\r", "\r").Replace("\\n", "\n");
    }

    private static Parity ParseSmsParity(string value)
        => Enum.TryParse(value, true, out Parity parsed) ? parsed : Parity.None;

    private static StopBits ParseSmsStopBits(string value)
        => Enum.TryParse(value, true, out StopBits parsed) ? parsed : StopBits.One;

    private static Handshake ParseSmsHandshake(string value)
        => Enum.TryParse(value, true, out Handshake parsed) ? parsed : Handshake.None;

    private sealed record SmsSendResult(bool Success, string Response);
    private sealed record SmsModuleSettings(
        int BaudRate,
        int DataBits,
        Parity Parity,
        StopBits StopBits,
        Handshake Handshake,
        int ReadTimeout,
        int WriteTimeout,
        string NewLine);

    private static bool TryReadJsonValue<T>(JsonNode? node, out T value)
    {
        if (node is JsonValue jsonValue)
        {
            try
            {
                value = jsonValue.GetValue<T>();
                return true;
            }
            catch
            {
                // ignored - will fall through to default
            }
        }

        value = default!;
        return false;
    }

    private string LiveButtonLabel => !_isPollingActive
    ? "Halted"
    : _isLiveMode ? "Live Feed" : "Demo";

    private string LiveButtonClass
    {
        get
        {
            if (!_isPollingActive)
                return "mon-live-btn btn btn-secondary";

            if (_isLiveMode)
                return "mon-live-btn";

            return "mon-live-btn btn btn-warning";
        }
    }

    private void EnsureSelectedDeviceSerialIsValid()
    {
        if (_devices.Count == 0)
            return;

        if (string.IsNullOrWhiteSpace(_selectedDeviceSerial))
            _selectedDeviceSerial = _devices[0].SerialNumber;
        else if (_selectedDeviceSerial != AllDevicesValue && _devices.All(d => d.SerialNumber != _selectedDeviceSerial))
            _selectedDeviceSerial = _devices[0].SerialNumber;
    }

    private string MonitoringTitle
    {
        get
        {
            if (_selectedDeviceSerial == AllDevicesValue)
                return "ALL DEVICES MONITORING";

            var deviceName = _devices.FirstOrDefault(d => d.SerialNumber == _selectedDeviceSerial)?.Name;
            if (!string.IsNullOrWhiteSpace(deviceName))
                return $"{deviceName.ToUpperInvariant()} MONITORING";

            return "GATE 1 MONITORING";
        }
    }
}
